

## Pgpool-II:

Pgpool-II is a middleware that sits between PostgreSQL clients and one or more PostgreSQL servers. It provides connection pooling, load balancing, high availability, and failover without changing your application code.


### Why Pgpool-II is used:

_Pgpool-II solves common PostgreSQL production problems:_
- Too many DB connections
- Read scalability
- Automatic failover
- Unified authentication
- Query routing (read/write split)


### Read/Write Splitting (Load Balancing): 

- `INSERT` / `UPDATE` / `DELETE` → sent to primary
- `SELECT` → sent to replicas




### Pgpool-II vs Alternatives:

| Tool      | Purpose                 | Read Balance | Failover |
| --------- | ----------------------- | ------------ | -------- |
| Pgpool-II | Full middleware         | ✅            | ✅        |
| PgBouncer | Connection pooling only | ❌            | ❌        |
| Patroni   | PostgreSQL HA           | ❌            | ✅        |
| HAProxy   | TCP routing             | ❌            | ❌        |




### Architecture Overview:

| Role               | IP                 |
| ------------------ | ------------------ |
| Pgpool-II          | **192.168.10.191** |
| PostgreSQL Primary | **192.168.10.192** |
| PostgreSQL Standby | **192.168.10.193** |



### Typical Architecture: 

```
Application
    |
 Pgpool-II
   /    \
Primary  Standby

```



## Primary: 192.168.10.192:

#### Configure `postgresql.conf`:

```bash
# - Connection Settings -
listen_addresses = '*'
port = 5432
max_connections = 1000

# - Authentication -
authentication_timeout = 1min
password_encryption = md5

# - Memory -
shared_buffers = 4096MB
huge_pages = try
temp_buffers = 128MB
work_mem = 128MB

# WRITE-AHEAD LOG
# - Settings -
wal_level = replica
wal_log_hints = on

# - Archiving -
#archive_mode = on		### archive mode on
#archive_command = 'cp %p /tmp/pgsql/archive/%f'

# REPLICATION
# - Sending Servers -
max_wal_senders = 10
max_replication_slots = 10

# - Primary Server -

# - Standby Servers -
hot_standby = on
```


#### Configure `pg_hba.conf`:

```bash
# IPv4 local connections:
host    all             all             0.0.0.0/0               md5

# Replication:
host    replication     replicator      192.168.10.192/32        md5
host    replication     replicator      192.168.10.193/32        md5

# Pgpool access:
host    all             all             192.168.10.191/32       md5

```


#### Create replication user:

_Start/Restart PostgreSQL:_
```
pg_ctl start -D $PGDATA
```


```
alter user postgres with password 'postgres';
```


```
CREATE USER replicator REPLICATION LOGIN ENCRYPTED PASSWORD 'replicator';
```



_Check Existing Replication Slots:_
```
SELECT * FROM pg_replication_slots;

SELECT slot_name, slot_type, active FROM pg_replication_slots;
```


_Drop the existing slot:_
```
SELECT pg_drop_replication_slot('standbyslot1');
```



## Standby: 192.168.10.193:

_Stop PostgreSQL:_
```
pg_ctl stop -D $PGDATA
```


```
cd /u01/pgsql/postgres/16.6/data

rm -rf *
```


_Take base backup:_
```
pg_basebackup -h 192.168.10.192 -U replicator -p 5432 -D /u01/pgsql/postgres/16.6/data -P -v -R -X stream -C -S standbyslot2
```


_Start PostgreSQL:_
```
pg_ctl start -D $PGDATA
```



```
SELECT pg_is_in_recovery();
```




---
---




## Install Pgpool-II (192.168.10.191):

```
dnf install -y epel-release
```

_For Pgpool-II 4.5 & PostgreSQL v16 (adjust version numbers as needed):_
```
dnf install -y https://www.pgpool.net/yum/rpms/4.5/redhat/rhel-8-x86_64/pgpool-II-release-4.5-1.noarch.rpm

dnf install -y pgpool-II-pg16 
```


```
pgpool --version

pgpool-II version 4.5.10 (hotooriboshi)
```



_PostgreSQL Client Instal:_
```
dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-$(rpm -E %rhel)-x86_64/pgdg-redhat-repo-latest.noarch.rpm

dnf -qy module disable postgresql

dnf install -y postgresql16
```


```
psql --version
```





### Pgpool-II Configuration: 


_Create a dedicated `pgpool` user on PRIMARY:_
```
CREATE ROLE pgpool WITH LOGIN PASSWORD 'pgpool_pass';

GRANT pg_monitor TO pgpool;
```



_Update `pg_hba.conf` on BOTH DB servers:_
```
host    all             pgpool             192.168.10.191/32       md5
```




#### Configure `/etc/pgpool-II/pgpool.conf`: 


```bash
backend_clustering_mode = 'streaming_replication'

# CONNECTIONS:
listen_addresses = '*'
port = 9999
unix_socket_directories = '/var/run/pgpool'

pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/var/run/pgpool'


# - Backend Connection Settings -
backend_hostname0 = '192.168.10.192'
backend_port0 = 5432
backend_weight0 = 1
backend_data_directory0 = '/u01/pgsql/postgres/16.6/data'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_application_name0 = 'server0'

backend_hostname1 = '192.168.10.193'
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = '/u01/pgsql/postgres/16.6/data'
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_application_name1 = 'server1'


# - Authentication -
enable_pool_hba = on
pool_passwd = '/etc/pgpool-II/pool_passwd'

# POOLS
num_init_children = 16
max_pool = 4 

# LOGS:
# - Where to log -
log_destination = 'stderr'

# - What to log -
log_statement = on

# This is used when logging to stderr:
logging_collector = on

# -- Only used if logging_collector is on ---
log_directory = '/var/log/pgpool_log'
log_filename = 'pgpool-%Y-%m-%d.log'


# FILE LOCATIONS
pid_file_name = '/var/run/pgpool/pgpool.pid'


# LOAD BALANCING MODE:
load_balance_mode = on
disable_load_balance_on_write = 'transaction'


# STREAMING REPLICATION MODE:
sr_check_period = 10
sr_check_user = 'pgpool'
sr_check_password = 'pgpool_pass'
sr_check_database = 'postgres'


# HEALTH CHECK GLOBAL PARAMETERS:
health_check_period = 10
health_check_timeout = 20
health_check_user = 'pgpool'
health_check_password = 'pgpool_pass'
health_check_database = 'postgres'
health_check_max_retries = 3
health_check_retry_delay = 5


# FAILOVER AND FAILBACK:
failover_command = '/etc/pgpool-II/failover.sh %d %h %p %D %m %H %r %R %M %P'

failback_command = '/etc/pgpool-II/failback.sh %d %h %p %D %H %r'


failover_on_backend_error = on


# ONLINE RECOVERY
#auto_failback = on

```




```
chmod 640 /etc/pgpool-II/pgpool.conf
```


_Create directory:_
```
mkdir -p /var/run/pgpool
chown postgres:postgres /var/run/pgpool
chmod 755 /var/run/pgpool
```



#### Authentication Setup:

```
pg_md5 -m -u postgres 'postgres'

pg_md5 -m -u pgpool 'pgpool_pass'
```


```
cat pool_passwd

postgres:md53175bxxxxxxxxxxxxxxxxxxxxxxx
pgpool:md507ffd03xxxxxxxxxxxxxxxxxxxxxxx
```



#### Configure `/etc/pgpool-II/pool_hba.conf`: 

```bash

host    all         all         0.0.0.0/0             md5
```




#### Configure `/etc/pgpool-II/pcp.conf`: 

```
pg_md5 pcp_pass
```



_Edit `/etc/pgpool-II/pcp.conf`:_
```bash

# USERID:MD5PASSW

## Add this line:
pgpooladmin:bbe93d2e911dc9f638a3da0b1350279d
```




#### Start PGpool:

_Start PGpool:_
```
systemctl start pgpool
systemctl status pgpool
```



```
netstat -tlpn | grep pgpool
```





### Create Failover Script: 
- Ensure passwordless SSH from Pgpool → `postgres` user on DB nodes

```bash 

#!/bin/bash
# Pgpool-II failover script

FAILED_NODE_ID="$1"
FAILED_HOST="$2"
FAILED_PORT="$3"
FAILED_DATADIR="$4"

NEW_MAIN_NODE_ID="$5"
NEW_MAIN_HOST="$6"
NEW_MAIN_PORT="$7"
NEW_MAIN_DATADIR="$8"

OLD_MAIN_NODE_ID="$9"
OLD_PRIMARY_NODE_ID="${10}"

LOGTAG="pgpool-failover"
PG_CTL="/u01/pgsql/postgres/16.6/bin/pg_ctl"

logger -t $LOGTAG "Failover started"
logger -t $LOGTAG "Failed node: id=$FAILED_NODE_ID host=$FAILED_HOST port=$FAILED_PORT"
logger -t $LOGTAG "New primary: id=$NEW_MAIN_NODE_ID host=$NEW_MAIN_HOST port=$NEW_MAIN_PORT"

# Safety check
if [ "$FAILED_NODE_ID" = "$NEW_MAIN_NODE_ID" ]; then
  logger -t $LOGTAG "ERROR: Failed node equals new primary. Aborting."
  exit 1
fi

# Promote standby
ssh -o StrictHostKeyChecking=no postgres@"$NEW_MAIN_HOST" \
  "$PG_CTL promote -D $NEW_MAIN_DATADIR"

if [ $? -ne 0 ]; then
  logger -t $LOGTAG "ERROR: Promotion failed on $NEW_MAIN_HOST"
  exit 1
fi

logger -t $LOGTAG "Promotion successful on $NEW_MAIN_HOST"
exit 0

```


```
chmod +x /etc/pgpool-II/failover.sh

chown postgres:postgres /etc/pgpool-II/failover.sh
```



### Create Failback Script: 

```bash
#!/bin/bash


```



```
chmod +x /etc/pgpool-II/failback.sh

chown postgres:postgres /etc/pgpool-II/failback.sh
```



### Verify:

_Check DB connection:_
```
psql -h 192.168.10.192 -p 5432 -U pgpool -d postgres -c "SELECT 1;"

psql -h 192.168.10.193 -p 5432 -U pgpool -d postgres -c "SELECT 1;"
```



_Connect via Pgpool:_
```
psql -h 127.0.0.1 -p 9999 -U pgpool -d postgres -c "show pool_nodes;"


### Output: 

 node_id |    hostname    | port | status | pg_status | lb_weight |  role   | pg_role | select_cnt | load_balance_node | replication_delay | replication_state | replication_sync_state | last_status_change
---------+----------------+------+--------+-----------+-----------+---------+---------+------------+-------------------+-------------------+-------------------+------------------------+---------------------
 0       | 192.168.10.192 | 5432 | up     | up        | 0.500000  | primary | primary | 0          | true              | 0                 |                   |                        | 2026-01-14 15:49:27
 1       | 192.168.10.193 | 5432 | up     | up        | 0.500000  | standby | standby | 0          | false             | 0                 |                   |                        | 2026-01-14 15:49:27
(2 rows)
```


Or,

```
psql -h 192.168.10.191 -p 9999 -U postgres


show pool_nodes;
```



_Load balance test:_
```
psql -h 127.0.0.1 -p 9999 -U pgpool -d postgres -c "SELECT inet_server_addr();"
```




_Check replication role from Pgpool:_
```
psql -h 127.0.0.1 -p 9999 -U pgpool -d postgres -c "SELECT pg_is_in_recovery();"
```



_Check node status:_
```
pcp_node_info -h 127.0.0.1 -p 9898 -U pgpooladmin -W -n 0
pcp_node_info -h 127.0.0.1 -p 9898 -U pgpooladmin -W -n 1


### Output:
192.168.10.192 5432 2 0.500000 up up primary primary 0 none none 2026-01-14 16:32:59
```







### Failover Test:

_Stop primary:_
```
pg_ctl stop -D $PGDATA
```

_Then,_
- Promote `192.168.10.193`
- Redirect traffic automatically




_Attach Primary or standby node:_
```
pcp_attach_node -h 127.0.0.1 -p 9898 -U pgpooladmin -W -n 0
pcp_attach_node -h 127.0.0.1 -p 9898 -U pgpooladmin -W -n 1
```

Reconnects a PostgreSQL backend node to Pgpool-II after it was marked down (or failed). It tells Pgpool-II to reattach node `0` or `1` (usually the failed node) as up, after failover/failback.


