## PgBouncer:

PgBouncer is a **lightweight, high-performance connection pooler** for PostgreSQL, acting as a middle layer that manages a pool of persistent database connections, reducing the overhead of creating new ones for every client request. It allows PostgreSQL to handle thousands of connections efficiently by reusing existing connections, preventing resource exhaustion and improving performance for applications with many short-lived or idle connections, making it ideal for microservices and high-traffic web applications. 

It sits between your application and PostgreSQL server and manages database connections efficiently.


### Why PgBouncer is Needed:

PostgreSQL has a **high cost per connection** (memory + process). Modern apps (web, microservices) may open **hundreds or thousands of connections**, which can overwhelm PostgreSQL.

_PgBouncer solves this by:_
- Reducing the number of actual PostgreSQL connections
- Reusing connections efficiently
- Improving performance and stability


### Key Features
- Massive connection reduction
- Supports MD5 & SCRAM authentication
- Works with replication & HA
- Admin console for stats
- Extremely low memory usage



### Architecture Overview:
- Apps connect to PgBouncer, not directly to PostgreSQL
- PgBouncer maintains a **small pool of backend DB connections**
- Client connections are **mapped to DB connections only when needed**


```
Application
     |
     v
 PgBouncer (pool)
     |
     v
PostgreSQL DB
```


### Pooling Modes:

| Mode        | Performance | Compatibility |
| ----------- | ----------- | ------------- |
| Session     | Low         | High          |
| Transaction | High ⭐     | Medium        |
| Statement   | Very High   | Low           |


#### 1️⃣ Session Pooling (default)
- One client ↔ one DB connection for entire session
- Compatible with most apps
- ❌ Less efficient

#### 2️⃣ Transaction Pooling ⭐ (Most Used)
- Connection assigned **per transaction**
- Released after COMMIT/ROLLBACK
- Huge performance gain
- ❌ Some session-level features won’t work

#### 3️⃣ Statement Pooling
- Connection per SQL statement
- Maximum efficiency
- ❌ Very limited (no transactions)




### PgBouncer vs Pgpool-II:

| Feature            | PgBouncer         | Pgpool-II |
| ------------------ | ---------         | --------- |
| Connection Pooling | ✅ Best          | ✅         |
| Query Routing      | ❌               | ✅         |
| Load Balancing     | ❌               | ✅         |
| HA / Failover      | ❌               | ✅         |
| Performance        | ⭐⭐⭐⭐⭐     | ⭐⭐⭐    |



---
---




## Install PgBouncer:

_Enable required repos:_
```
dnf install -y epel-release
```


```
dnf install -y pgbouncer
```


```
pgbouncer --version
```


```
cat /etc/passwd | grep pgbouncer

pgbouncer:x:989:989:PgBouncer Server:/home/pgbouncer:/usr/bin/bash
```



### Build the binaries from the source code:

```
wget https://www.pgbouncer.org/downloads/files/1.25.1/pgbouncer-1.25.1.tar.gz
```

```
cd pgbouncer-1.25.1
./configure --prefix=/usr/local
make
make install
```


```
mkdir -p /etc/pgbouncer
mkdir -p /var/log/pgbouncer
mkdir -p /var/run/pgbouncer
```



### Configure PgBouncer:

_Sample pgbouncer configuration on `/etc/pgbouncer/pgbouncer.ini`:_

```conf

[databases]
#* = host=192.168.10.193 port=5432
#postgres = host=192.168.10.193 port=5432 dbname=postgres
#pgbench  = host=192.168.10.193 port=5432 dbname=pgbench
pagila  = host=192.168.10.193 port=5432 dbname=pagila
#appdb1 = host=192.168.10.193 port=5432 dbname=appdb1


[users]


[pgbouncer]
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

listen_addr = 0.0.0.0
listen_port = 6432

auth_type = md5   ## scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

admin_users = postgres
stats_users = stats, postgres

pool_mode = transaction

max_client_conn = 1000
default_pool_size = 50
min_pool_size = 10

reserve_pool_size = 20
reserve_pool_timeout = 5

log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

server_lifetime = 3600
server_idle_timeout = 60
client_idle_timeout = 300

```



### Create Authentication File:  

```
alter user postgres with encrypted password 'postgres';
```


```
SELECT rolname, rolpassword FROM pg_authid;
```



```
show max_connections;

 max_connections
-----------------
 100
(1 row)
```



_Example of a valid userlist.txt file `/etc/pgbouncer/userlist.txt`:_
```
"someuser" "md5_password"
```


```
"postgres" "md5e8a4865xxxxxxxxxxxxxxx"
"pagila" "md5ee6784667xxxxxxxxxxxxxxx"
```



```
chown -R pgbouncer:pgbouncer /etc/pgbouncer
```


### Edit `pg_hba.conf`: 

```
# IPv4 local connections:
host    all             all             0.0.0.0/0            md5
```


### Starting PgBouncer:

PgBouncer cannot be started as `root`. It has to be started as a **regular user**.

```
su - pgbouncer

pgbouncer -d /etc/pgbouncer/pgbouncer.ini
```


_Stopping PgBouncer:_
```
kill `cat /var/run/pgbouncer/pgbouncer.pid`
```


Or,

```
systemctl start pgbouncer
```


```
netstat -tlpn | grep 6432
```




### Test PgBouncer Connection: 

_Direct PostgreSQL:_
```
psql -h 192.168.10.193 -p 5432 -U postgres -d postgres
```


_Via PgBouncer:_
```
psql -h 127.0.0.1 -p 6432 -U postgres -d postgres

psql -h 127.0.0.1 -p 6432 -U pagila -d pagila
```



### Check Benchmark:

_Initialize pgbench tables via PostgreSQL:_
- `-s`  : Scale factor

```
createdb pgbench

pgbench -i -s 10 pgbench

pgbench -i -s 10 pagila
```


_Run Directly on PostgreSQL:_
- `-c 20` :	clients
- `-j 4`  : threads
- `-T 60` : duration (seconds)

```
pgbench -h 192.168.10.193 -p 5432 -U postgres -c 20 -j 4 -T 60 pgbench
```



_Via PgBouncer:_
```
/usr/pgsql-16/bin/pgbench -h 127.0.0.1 -p 6432 -U postgres -c 200 -j 10 -T 60 -M simple pgbench

/usr/pgsql-16/bin/pgbench -h 127.0.0.1 -p 6432 -U postgres -c 500 -j 10 -T 60 -M simple pagila
```




### PgBouncer Limitations
- ❌ Not a load balancer
- ❌ Does NOT do query routing
- ❌ Session features may break in transaction mode:
- Temporary tables
- Prepared statements
- Session variables



### Ref:

- [PgBouncer compilation and installation](https://www.pgbouncer.org/install.html)
- [PgBouncer Source releases](https://www.pgbouncer.org/downloads/)
- [pgbouncer.ini](https://www.pgbouncer.org/config.html)




