## pgBackRest:

pgBackRest is a reliable backup and restore solution for PostgreSQL that seamlessly scales up to the largest databases and workloads. It is a modern, production-grade backup & restore tool for PostgreSQL. It’s fast, safe, and basically the grown-up answer to `pg_dump` and `pg_basebackup` when you’re running real systems.


### Key Features:
- Parallel Backup & Restore
- Local or Remote Operation
- Multiple Repositories
- Full, Differential, & Incremental Backups (at File or Block Level)
- Backup Rotation & Archive Expiration
- Backup Integrity
- Backup Resume
- Streaming Compression & Checksums
- Parallel, Asynchronous WAL Push & Get
- Tablespace & Link Support
- S3, Azure, and GCS Compatible Object Store Support


### When to used pgBackRest:
- Large database backups
- Flexible backup types
- High performance requirements
- Data integrity concerns
- Cloud-based deployments 



### Architecture:

For a standalone PostgreSQL instance, we used two servers:

| Server            | IP                |     Role      |
| ----------------- | ----------------- | ------------- |
| PostgreSQL Server | 192.168.10.191    | PostgreSQL Server + pgBackRest |
| Backup Server     | 192.168.10.193    | PostgreSQL Client + pgBackRest |





---
---




## Installing pgBackRest:


_Install pgBackRest (BOTH servers):_
```
## RHEL/CentOS:
dnf install -y pgbackrest

or,

## Debian/Ubuntu: 
apt install -y pgbackrest
```


_Check version and pgBackRest v2.58.0 is the current stable release:_
```
pgbackrest --version

pgBackRest 2.58.0
```



### Configure `pg_hba.conf` (192.168.10.191):

- pgBackRest does **NOT use SQL replication connections**
- It uses **SSH + filesystem access**
- This `backup` role is never used and if need this for use `pg_basebackup`.


```conf

## for pgBackRest backup user:
host    replication     backup          192.168.10.193/32   md5
```


_Create `backup` user:_
```
create role backup with login replication password 'backup';
```



### Configure PostgreSQL WAL Settings (192.168.10.191):

_Configure on `postgresql.conf`:_

```conf

## - Archiving -
archive_mode = on
archive_command = 'pgbackrest --stanza=main archive-push %p'

#restore_command = 'pgbackrest --stanza=main archive-get %f %p'
```


```
pg_ctl stop -D /u01/pgsql/16.6/data
pg_ctl start -D /u01/pgsql/16.6/data
```



```
psql -d postgres

show archive_mode;
show archive_command;
```




### Configure Passwordless SSH: (BOTH servers)

Configure Passwordless SSH from backup host and Postgres Server. 


_Set OS password `postgres`: (BOTH servers)_
```
passwd postgres
```


_Form PostgreSQL Server:_
```
ssh-keygen
ssh-copy-id postgres@192.168.10.193

ssh postgres@192.168.10.193 hostname
```


_Form Backup Server:_
```
ssh-keygen
ssh-copy-id postgres@192.168.10.191

ssh postgres@192.168.10.191 hostname
```



### Create Backup Directory: (BOTH servers)

```
mkdir -p /var/lib/pgbackrest
chown postgres:postgres /var/lib/pgbackrest
chmod 750 /var/lib/pgbackrest

mkdir -p /var/log/pgbackrest
chown postgres:postgres /var/log/pgbackrest
```



### Configure pgBackRest (192.168.10.191): 

pgBackRest uses a simple configuration file approach. Create `/etc/pgbackrest.conf`:

```conf 
[global]

repo1-host=192.168.10.193    ## Backup host
repo1-host-user=postgres
repo1-path=/var/lib/pgbackrest  ## Where backups are stored
repo1-retention-full=2

## general options
log-level-console=info
process-max=2    ## Number of WAL push processes
start-fast=y


[main]  ## Your stanza name (typically your database name)
pg1-path=/u01/pgsql/16.6/data   ## PostgreSQL data directory
pg1-port=5432
```



### Configure pgBackRest (192.168.10.193): 

pgBackRest uses a simple configuration file approach. Create file `/etc/pgbackrest.conf`:

```conf

[global]
repo1-path=/var/lib/pgbackrest  ## Where backups are stored
repo1-retention-full=2
log-level-console=info

start-fast=y
process-max=2   ## Parallel WAL retrieval for restores

[main]
pg1-host=192.168.10.191
pg1-port=5432
pg1-host-user=postgres
pg1-path=/u01/pgsql/16.6/data
```




---
---




## Create Stanza on Backup Server (192.168.10.193):

_From backup server:_
```
su - postgres

pgbackrest --stanza=main stanza-create
```


```
### Output:

2026-01-26 17:25:48.736 P00   INFO: stanza-create command begin 2.58.0: --exec-id=1861042-992f42df --log-level-console=info --pg1-host=192.168.10.191 --pg1-host-user=postgres --pg1-path=/u01/pgsql/16.6/data --pg1-port=5432 --repo1-path=/var/lib/pgbackrest --stanza=main
2026-01-26 17:25:48.956 P00   INFO: stanza-create for stanza 'main' on repo1
2026-01-26 17:25:49.063 P00   INFO: stanza-create command end: completed successfully (328ms)
```



_Check Command:_
- The `check` command will trigger a new WAL segment to be archived and try to push it to all defined repositories:

```
pgbackrest check
```



### Take First Backup:

- **Full** : entire cluster
- **Differential** : changes since last full
- **Incremental** : changes since last backup (small & fast)


_From backup server:_
```
pgbackrest --stanza=main backup --type=full
```


_Backup on Differential and Incremental:_
```
pgbackrest --stanza=main backup --type=diff
pgbackrest --stanza=main backup --type=incr
```



_Check status and verify:_
```
pgbackrest info

pgbackrest info --stanza=main

pgbackrest verify --stanza=main
```



#### Remove the entire stanza  (192.168.10.193):

```
pgbackrest --stanza=main stop

pgbackrest --stanza=main stanza-delete --force
```




---
---




## Restore Scenario (Disaster Recovery):

_If Force WAL switch on DB Server: (192.168.10.191)_
```
SELECT pg_switch_wal();

 pg_switch_wal
---------------
 0/3000078
(1 row)
```




### Stop PostgreSQL server (192.168.10.191):

```
pg_ctl stop -D /u01/pgsql/16.6/data
```


```
cd /u01/pgsql/16.6
mv data data.old

mkdir data
```



#### Full Restore: 

_Then, Run restore on PostgreSQL server (192.168.10.191):_

```
pgbackrest --stanza=main restore
```



_Start PostgreSQL server:_
```
pg_ctl start -D /u01/pgsql/16.6/data
```






### Point-in-Time Recovery (PITR):

- `--delta` option allows pgBackRest to restore only the changed files (Partial Restore), reducing time and risk.

- Does NOT delete `/u01/pgsql/16.6/data`
- Compares files in the data directory with the backup
- **Only copies files that are missing or different**


```
pg_ctl stop -D /u01/pgsql/16.6/data
```


```
pgbackrest --stanza=main restore --type=time --target="2026-01-27 14:41:22" --delta

pgbackrest --stanza=main restore --set=20260127-130804F_20260127-131500I --delta
```


```
pg_ctl start -D /u01/pgsql/16.6/data
```





---
---



## Creating a Backup Strategy:

- **Weekly full backups** for complete restoration points
- **Daily differential backups** for quick recovery of recent changes
- **Incremental backups (Optional)** for minimal storage impact with frequent backup points


A typical production backup strategy might look like:

```bash
sudo -u postgres crontab -e


## Full backup every Sunday at 2 AM
0 2 * * 0 /usr/bin/pgbackrest --stanza=main backup --type=full 

## Differential backup Monday through Saturday at 2 AM (except Sunday)
0 2 * * 1-6 /usr/bin/pgbackrest --stanza=main backup --type=diff 

## Optional: Incremental backups every 4 hours during business days
0 */4 * * 1-5 /usr/bin/pgbackrest --stanza=main backup --type=incr 
```



### Ref: 
- [pgBackRest Configuration Reference](https://pgbackrest.org/configuration.html)





















